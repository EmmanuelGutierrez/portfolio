---
import Card from "./Card.astro";

interface Props {
  id: string;
  triggerClass?: string;
  contentClass?: string;
}

const { id, triggerClass = "contents", contentClass = "" } = Astro.props;
---

<div class={triggerClass} data-open-modal={id}>
  <slot name="trigger" />
</div>

<div
  id={id}
  class="fixed inset-0 z-50 grid place-content-center bg-black/60 backdrop-blur-sm p-4 opacity-0 pointer-events-none transition-all duration-300"
  role="dialog"
  aria-modal="true"
  aria-hidden="true"
>
  <Card
    class={`relative w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl transition-all transform scale-95 ${contentClass}`}
    data-modal-content
  >
    <!-- Close Button -->
    <button
      type="button"
      class="absolute top-4 right-4 z-10 rounded-full p-2 text-text-muted hover:bg-border-subtle hover:text-text-main transition-colors"
      data-close-modal
      aria-label="Cerrar modal"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="size-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

    <div class="mt-2">
      <slot />
    </div>
  </Card>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const triggers = document.querySelectorAll("[data-open-modal]");

    triggers.forEach((trigger) => {
      const modalId = trigger.getAttribute("data-open-modal");
      if (!modalId) return;
      const modal = document.getElementById(modalId);
      if (!modal) return;

      const closeButtons = modal.querySelectorAll("[data-close-modal]");
      const modalContent = modal.querySelector("[data-modal-content]");

      const openModal = () => {
        modal.classList.remove("opacity-0", "pointer-events-none");
        modal.classList.add("opacity-100", "pointer-events-auto");
        
        // Animate content scale
        if (modalContent) {
           modalContent.classList.remove("scale-95");
           modalContent.classList.add("scale-100");
        }

        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      };

      const closeModal = () => {
        modal.classList.add("opacity-0", "pointer-events-none");
        modal.classList.remove("opacity-100", "pointer-events-auto");
        
        // Reset scale
        if (modalContent) {
           modalContent.classList.add("scale-95");
           modalContent.classList.remove("scale-100");
        }

        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      };

      trigger.addEventListener("click", (e) => {
        // Prevent opening if clicking a link inside the trigger
        if ((e.target as HTMLElement).closest("a")) return;
        // Also prevent if clicking a button inside (unless it's the trigger itself, but we wrapped it)
        // If the user puts a button inside the trigger slot, we might want to respect that button's action if it propagates?
        // But usually the trigger IS the action.
        // Let's stick to the link check.
        openModal();
      });

      closeButtons.forEach((btn) =>
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          closeModal();
        })
      );

      modal.addEventListener("click", (e) => {
        if (modalContent && !modalContent.contains(e.target as Node)) {
          closeModal();
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !modal.classList.contains("opacity-0")) {
          closeModal();
        }
      });
    });
  });
</script>
